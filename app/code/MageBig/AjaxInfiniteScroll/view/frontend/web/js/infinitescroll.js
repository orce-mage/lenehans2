var mbCall=function(t){return this.list=[],this.fireStack=[],this.isFiring=!1,this.isDisabled=!1,this.Deferred=t.Deferred,this.fire=function(t){var e=t[0],i=t[1],n=t[2];this.isFiring=!0;for(var r=0,s=this.list.length;s>r;r++)if(void 0!=this.list[r]&&!1===this.list[r].fn.apply(e,n)){i.reject();break}this.isFiring=!1,i.resolve(),this.fireStack.length&&this.fire(this.fireStack.shift())},this.inList=function(t,e){e=e||0;for(var i=e,n=this.list.length;n>i;i++)if(this.list[i].fn===t||t.guid&&this.list[i].fn.guid&&t.guid===this.list[i].fn.guid)return i;return-1},this};mbCall.prototype={add:function(t,e){var i={fn:t,priority:e};e=e||0;for(var n=0,r=this.list.length;r>n;n++)if(e>this.list[n].priority)return this.list.splice(n,0,i),this;return this.list.push(i),this},remove:function(t){for(var e=0;(e=this.inList(t,e))>-1;)this.list.splice(e,1);return this},has:function(t){return this.inList(t)>-1},fireWith:function(t,e){var i=this.Deferred();return this.isDisabled?i.reject():(e=e||[],e=[t,i,e.slice?e.slice():e],this.isFiring?this.fireStack.push(e):this.fire(e),i)},disable:function(){this.isDisabled=!0},enable:function(){this.isDisabled=!1}},function(t){"use strict";var e=-1,i=function(i,n){return this.itemsContainerSelector=n.container,this.itemSelector=n.item,this.nextSelector=n.next,this.paginationSelector=n.pagination,this.$scrollContainer=i,this.$container=window===i.get(0)?t(document):i,this.defaultDelay=n.delay,this.negativeMargin=n.negativeMargin,this.nextUrl=null,this.isBound=!1,this.isPaused=!1,this.isInitialized=!1,this.jsXhr=!1,this.listeners={next:new mbCall(t),load:new mbCall(t),loaded:new mbCall(t),render:new mbCall(t),rendered:new mbCall(t),scroll:new mbCall(t),noneLeft:new mbCall(t),ready:new mbCall(t)},this.extensions=[],this.scrollHandler=function(){if(this.isBound&&!this.isPaused){var t=this.getCurrentScrollOffset(this.$scrollContainer),i=this.getScrollThreshold();e!=i&&(this.fire("scroll",[t,i]),t>=i&&this.next())}},this.getItemsContainer=function(){return t(this.itemsContainerSelector,this.$container)},this.getLastItem=function(){return t(this.itemSelector,this.getItemsContainer().get(0)).last()},this.getFirstItem=function(){return t(this.itemSelector,this.getItemsContainer().get(0)).first()},this.getScrollThreshold=function(t){var i;return t=t||this.negativeMargin,t=t>=0?-1*t:t,i=this.getLastItem(),0===i.length?e:i.offset().top+i.height()+t},this.getCurrentScrollOffset=function(t){var e=0,i=t.height();return e=window===t.get(0)?t.scrollTop():t.offset().top,(-1!=navigator.platform.indexOf("iPhone")||-1!=navigator.platform.indexOf("iPod"))&&(i+=80),e+i},this.getNextUrl=function(e){return e=e||this.$container,t(this.nextSelector,e).last().attr("href")},this.load=function(e,i,n){function r(e){s=t(this.itemsContainerSelector,e).eq(0),0===s.length&&(s=t(e).filter(this.itemsContainerSelector).eq(0)),s&&s.find(this.itemSelector).each(function(){a.push(this)}),h.fire("loaded",[e,a]),i&&(o=+new Date-l,n>o?setTimeout(function(){i.call(h,e,a)},n-o):i.call(h,e,a))}var s,o,h=this,a=[],l=+new Date;n=n||this.defaultDelay;var f={url:e,ajaxOptions:{dataType:"html"}};return h.fire("load",[f]),this.jsXhr=t.ajax(f.url,f.ajaxOptions).done(t.proxy(r,h)),this.jsXhr},this.render=function(e,i){var n=this,r=this.getLastItem(),s=0,o=this.fire("render",[e]);o.done(function(){t(e).hide(),r.after(e),t(e).fadeIn(400,function(){++s<e.length||(n.fire("rendered",[e]),i&&i())})}),o.fail(function(){i&&i()})},this.hidePagination=function(){this.paginationSelector&&t(this.paginationSelector,this.$container).hide()},this.restorePagination=function(){this.paginationSelector&&t(this.paginationSelector,this.$container).show()},this.throttle=function(e,i){var n,r,s=0;return n=function(){function t(){s=+new Date,e.apply(n,o)}var n=this,o=arguments,h=+new Date-s;r?clearTimeout(r):t(),h>i?t():r=setTimeout(t,i)},t.guid&&(n.guid=e.guid=e.guid||t.guid++),n},this.fire=function(t,e){return this.listeners[t].fireWith(this,e)},this.pause=function(){this.isPaused=!0},this.resume=function(){this.isPaused=!1},this};i.prototype.initialize=function(){if(this.isInitialized)return!1;var t=!!("onscroll"in this.$scrollContainer.get(0)),e=this.getCurrentScrollOffset(this.$scrollContainer),i=this.getScrollThreshold();return!!t&&(this.hidePagination(),this.bind(),this.nextUrl=this.getNextUrl(),this.nextUrl||this.fire("noneLeft",[this.getLastItem()]),this.nextUrl&&e>=i?(this.next(),this.one("rendered",function(){this.isInitialized=!0,this.fire("ready")})):(this.isInitialized=!0,this.fire("ready")),this)},i.prototype.reinitialize=function(){this.isInitialized=!1,this.unbind(),this.initialize()},i.prototype.bind=function(){if(!this.isBound){this.$scrollContainer.on("scroll",t.proxy(this.throttle(this.scrollHandler,150),this));for(var e=0,i=this.extensions.length;i>e;e++)this.extensions[e].bind(this);this.isBound=!0,this.resume()}},i.prototype.unbind=function(){if(this.isBound){this.$scrollContainer.off("scroll",this.scrollHandler);for(var t=0,e=this.extensions.length;e>t;t++)"undefined"!=typeof this.extensions[t].unbind&&this.extensions[t].unbind(this);this.isBound=!1}},i.prototype.destroy=function(){try{this.jsXhr.abort()}catch(t){}this.unbind(),this.$scrollContainer.data("mbs",null)},i.prototype.on=function(e,i,n){if("undefined"==typeof this.listeners[e])throw new Error('There is no event called "'+e+'"');return n=n||0,this.listeners[e].add(t.proxy(i,this),n),this.isInitialized&&("ready"===e?t.proxy(i,this)():"noneLeft"!==e||this.nextUrl||t.proxy(i,this)()),this},i.prototype.one=function(t,e){var i=this,n=function(){i.off(t,e),i.off(t,n)};return this.on(t,e),this.on(t,n),this},i.prototype.off=function(t,e){if("undefined"==typeof this.listeners[t])throw new Error('There is no event called "'+t+'"');return this.listeners[t].remove(e),this},i.prototype.next=function(){var t=this.nextUrl,e=this;if(!t)return!1;this.pause();var i=this.fire("next",[t]);return i.done(function(){e.load(t,function(t,i){e.render(i,function(){e.nextUrl=e.getNextUrl(t),e.nextUrl||e.fire("noneLeft",[e.getLastItem()]),e.resume()})})}),i.fail(function(){e.resume()}),!0},i.prototype.extension=function(t){if("undefined"==typeof t.bind)throw new Error('Extension doesn\'t have required method "bind"');return"undefined"!=typeof t.initialize&&t.initialize(this),this.extensions.push(t),this.isBound&&this.reinitialize(),this},t.mbs=function(e){var i=t(window);return i.mbs.apply(i,arguments)},t.fn.mbs=function(e){var n=Array.prototype.slice.call(arguments),r=this;return this.each(function(){var s=t(this),o=s.data("mbs"),h=t.extend({},t.fn.mbs.defaults,s.data(),"object"==typeof e&&e);if(o||(s.data("mbs",o=new i(s,h)),h.initialize&&t(document).ready(t.proxy(o.initialize,o))),"string"==typeof e){if("function"!=typeof o[e])throw new Error('There is no method called "'+e+'"');n.shift(),o[e].apply(o,n)}r=o}),r},t.fn.mbs.defaults={item:".item",container:".listing",next:".next",pagination:!1,delay:600,negativeMargin:10,initialize:!0}}(jQuery);var mbHistoryEx=function(t){return t=jQuery.extend({},this.defaults,t),this.mbs=null,this.prevSelector=t.prev,this.prevUrl=null,this.listeners={prev:new mbCall(jQuery)},this.onPageChange=function(t,e,i){if(window.history&&window.history.replaceState){var n=history.state;i=i.split('%2C').join(',');window.history.pushState({url:i},document.title,i)}},this.onScroll=function(t,e){var i=this.getScrollThresholdFirstItem();this.prevUrl&&(t-=this.mbs.$scrollContainer.height(),i>=t&&this.prev())},this.onReady=function(){var t=this.mbs.getCurrentScrollOffset(this.mbs.$scrollContainer),e=this.getScrollThresholdFirstItem();t-=this.mbs.$scrollContainer.height(),e>=t&&this.prev()},this.getPrevUrl=function(t){return t||(t=this.mbs.$container),jQuery(this.prevSelector,t).last().attr("href")},this.getScrollThresholdFirstItem=function(){var t;return t=this.mbs.getFirstItem(),0===t.length?-1:t.offset().top},this.renderBefore=function(t,e){var i=this.mbs,n=i.getFirstItem(),r=0;i.fire("render",[t]),jQuery(t).hide(),n.before(t),jQuery(t).fadeIn(400,function(){++r<t.length||(i.fire("rendered",[t]),e&&e())})},this};mbHistoryEx.prototype.initialize=function(t){var e=this;this.mbs=t,jQuery.extend(t.listeners,this.listeners),t.prev=function(){return e.prev()},this.prevUrl=this.getPrevUrl()},mbHistoryEx.prototype.bind=function(t){t.on("pageChange",jQuery.proxy(this.onPageChange,this)),t.on("scroll",jQuery.proxy(this.onScroll,this)),t.on("ready",jQuery.proxy(this.onReady,this))},mbHistoryEx.prototype.unbind=function(t){t.off("pageChange",this.onPageChange),t.off("scroll",this.onScroll),t.off("ready",this.onReady)},mbHistoryEx.prototype.prev=function(){var t=this.prevUrl,e=this,i=this.mbs;if(!t)return!1;i.pause();var n=i.fire("prev",[t]);return n.done(function(){i.load(t,function(t,n){e.renderBefore(n,function(){e.prevUrl=e.getPrevUrl(t),i.resume(),e.prevUrl&&e.prev()})})}),n.fail(function(){i.resume()}),!0},mbHistoryEx.prototype.defaults={prev:".prev"};var mbEndEx=function(t){return t=jQuery.extend({},this.defaults,t),this.mbs=null,this.uid=(new Date).getTime(),this.html=t.html.replace("{text}",t.text),this.showNoneLeft=function(){var t=jQuery(this.html).attr("id","no_more_"+this.uid),e=this.mbs.getLastItem();e.parent().parent().append(t),t.fadeIn()},this};mbEndEx.prototype.bind=function(t){this.mbs=t,t.on("noneLeft",jQuery.proxy(this.showNoneLeft,this))},mbEndEx.prototype.unbind=function(t){t.off("noneLeft",this.showNoneLeft)},mbEndEx.prototype.defaults={text:"You reached the end.",html:'<div class="mbs-noneleft" style="text-align: center;">{text}</div>'};var mbPagingEx=function(){return this.mbs=null,this.pagebreaks=[[0,document.location.toString()]],this.lastPageNum=1,this.enabled=!0,this.listeners={pageChange:new mbCall(jQuery)},this.onScroll=function(t,e){if(this.enabled){var i,n=this.mbs,r=this.getCurrentPageNum(t),s=this.getCurrentPagebreak(t);this.lastPageNum!==r&&(i=s[1],n.fire("pageChange",[r,t,i])),this.lastPageNum=r}},this.onNext=function(t){var e=this.mbs.getCurrentScrollOffset(this.mbs.$scrollContainer);this.pagebreaks.push([e,t]);var i=this.getCurrentPageNum(e)+1;this.mbs.fire("pageChange",[i,e,t]),this.lastPageNum=i},this.onPrev=function(t){var e=this,i=e.mbs,n=i.getCurrentScrollOffset(i.$scrollContainer),r=n-i.$scrollContainer.height(),s=i.getFirstItem();this.enabled=!1,this.pagebreaks.unshift([0,t]),i.one("rendered",function(){for(var n=1,o=e.pagebreaks.length;o>n;n++)e.pagebreaks[n][0]=e.pagebreaks[n][0]+s.offset().top;var h=e.getCurrentPageNum(r)+1;i.fire("pageChange",[h,r,t]),e.lastPageNum=h,e.enabled=!0})},this};mbPagingEx.prototype.initialize=function(t){this.mbs=t,jQuery.extend(t.listeners,this.listeners)},mbPagingEx.prototype.bind=function(t){try{t.on("prev",jQuery.proxy(this.onPrev,this),this.priority)}catch(t){}t.on("next",jQuery.proxy(this.onNext,this),this.priority),t.on("scroll",jQuery.proxy(this.onScroll,this),this.priority)},mbPagingEx.prototype.unbind=function(t){try{t.off("prev",this.onPrev)}catch(t){}t.off("next",this.onNext),t.off("scroll",this.onScroll)},mbPagingEx.prototype.getCurrentPageNum=function(t){for(var e=this.pagebreaks.length-1;e>0;e--)if(t>this.pagebreaks[e][0])return e+1;return 1},mbPagingEx.prototype.getCurrentPagebreak=function(t){for(var e=this.pagebreaks.length-1;e>=0;e--)if(t>this.pagebreaks[e][0])return this.pagebreaks[e];return null},mbPagingEx.prototype.priority=500;var mbLoadingEx=function(t){return t=jQuery.extend({},this.defaults,t),this.mbs=null,this.uid=(new Date).getTime(),this.src=t.src,this.html=t.html.replace("{src}",this.src),this.showSpinner=function(){var t=this.getSpinner()||this.createSpinner(),e=this.mbs.getLastItem();e.parent().parent().append(t),t.fadeIn()},this.showSpinnerBefore=function(){var t=this.getSpinner()||this.createSpinner(),e=this.mbs.getFirstItem();e.parent().parent().prepend(t),t.fadeIn()},this.removeSpinner=function(){this.hasSpinner()&&this.getSpinner().remove()},this.getSpinner=function(){var t=jQuery("#mbs-spinner_"+this.uid);return t.length>0&&t},this.hasSpinner=function(){var t=jQuery("#mbs-spinner_"+this.uid);return t.length>0},this.createSpinner=function(){var t=jQuery(this.html).attr("id","mbs-spinner_"+this.uid);return t.hide(),t},this};mbLoadingEx.prototype.bind=function(t){this.mbs=t,t.on("next",jQuery.proxy(this.showSpinner,this)),t.on("render",jQuery.proxy(this.removeSpinner,this));try{t.on("prev",jQuery.proxy(this.showSpinnerBefore,this))}catch(t){}},mbLoadingEx.prototype.unbind=function(t){t.off("next",this.showSpinner),t.off("render",this.removeSpinner);try{t.off("prev",this.showSpinnerBefore)}catch(t){}},mbLoadingEx.prototype.defaults={src:"",html:'<div class="mbs-spinner" style="text-align: center;"><img src="{src}"/></div>'};var mbTriggerEx=function(t){return t=jQuery.extend({},this.defaults,t),this.mbs=null,this.html=t.html.replace("{text}",t.text),this.htmlPrev=t.htmlPrev.replace("{text}",t.textPrev),this.enabled=!0,this.count=0,this.offset=t.offset,this.$triggerNext=null,this.$triggerPrev=null,this.showTriggerNext=function(){if(!this.enabled)return!0;if(!1===this.offset||++this.count<this.offset)return!0;var t=this.$triggerNext||(this.$triggerNext=this.createTrigger(this.next,this.html)),e=this.mbs.getLastItem();return e.parent().parent().append(t),t.fadeIn(),!1},this.showTriggerPrev=function(){if(!this.enabled)return!0;var t=this.$triggerPrev||(this.$triggerPrev=this.createTrigger(this.prev,this.htmlPrev)),e=this.mbs.getFirstItem();return e.parent().parent().prepend(t),t.fadeIn(),!1},this.onRendered=function(){this.enabled=!0},this.createTrigger=function(t,e){var i,n=(new Date).getTime();return e=e||this.html,i=jQuery(e).attr("id","mb_trigger_"+n),i.hide(),i.on("click",jQuery.proxy(t,this)),i},this};mbTriggerEx.prototype.bind=function(t){this.mbs=t,t.on("next",jQuery.proxy(this.showTriggerNext,this),this.priority),t.on("rendered",jQuery.proxy(this.onRendered,this),this.priority);try{t.on("prev",jQuery.proxy(this.showTriggerPrev,this),this.priority)}catch(t){}},mbTriggerEx.prototype.unbind=function(t){t.off("next",this.showTriggerNext),t.off("rendered",this.onRendered);try{t.off("prev",this.showTriggerPrev)}catch(t){}},mbTriggerEx.prototype.next=function(){this.enabled=!1,this.mbs.pause(),this.$triggerNext&&(this.$triggerNext.remove(),this.$triggerNext=null),this.mbs.next()},mbTriggerEx.prototype.prev=function(){this.enabled=!1,this.mbs.pause(),this.$triggerPrev&&(this.$triggerPrev.remove(),this.$triggerPrev=null),this.mbs.prev()},mbTriggerEx.prototype.defaults={text:"Load more items",html:'<div class="mbs-trigger mbs-trigger-next" style="text-align: center; cursor: pointer;"><a>{text}</a></div>',textPrev:"Load previous items",htmlPrev:'<div class="mbs-trigger mbs-trigger-prev" style="text-align: center; cursor: pointer;"><a>{text}</a></div>',offset:0},mbTriggerEx.prototype.priority=1e3;window.mbPagingEx=mbPagingEx;window.mbHistoryEx=mbHistoryEx;window.mbTriggerEx=mbTriggerEx;window.mbLoadingEx=mbLoadingEx;window.mbEndEx=mbEndEx;
