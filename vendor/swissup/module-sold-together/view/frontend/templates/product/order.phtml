<?php
    $htmlBlockId = $block->getNameInLayout();
    $_items = $block->getItems();
    $taxDisplay = $block->getTaxDisplayConfig();
    $isAmazonStripe = $block->getLayoutStyle() == 'amazon-stripe';
    $isAmazonDefault = $block->getLayoutStyle() == 'amazon-default';
    if (!$block->hasData('image_id')) {
        $block->setData('image_id', 'related_products_list');
    }

    $imageId = $block->getData('image_id');
?>
<?php if ($block->getConfig('enabled') && $_items && $_items->getSize() > 0) : ?>
<div class="block soldtogether-block <?= $block->getLayoutStyle(); ?>" id="<?= $htmlBlockId ?>">
    <div class="block-title title" id="<?= $htmlBlockId ?>-title">
        <strong class="block-order-heading" role="heading" aria-level="2"><?= /* @escapeNotVerified */ __($block->hasData('title') ? $block->getData('title') : 'Frequently Bought Together'); ?></strong>
    </div>
    <div class="block-content content" aria-labelledby="<?= $htmlBlockId ?>-title">
        <ul class="amazonstyle-images">
            <li id="soldtogether-image-<?= (int)$block->getProduct()->getId() ?>" class="first item product-item">
                <span class="product photo product-item-photo">
                <?php if ($isAmazonStripe): ?>
                    <input type="checkbox"
                       class="checkbox main-product"
                       id="relatedorderstripe-checkbox<?= (int)$block->getProduct()->getId() ?>"
                       onclick="return false;"
                       disabled="disabled"
                       name="bought_related_products[]"
                       value="<?= (int)$block->getProduct()->getId() ?>" checked="checked"/>
                <?php endif; ?>
                    <?= $block->getImageHtml($block->getProduct(), $imageId); ?>
                </span>
                <?php if ($isAmazonStripe): ?>
                <div class="product details product-item-details">
                    <label class="product name product-item-name" for="relatedorderstripe-checkbox<?= (int)$block->getProduct()->getId() ?>">
                        <span class="product-item-link" title="<?= $block->escapeHtml($block->getProduct()->getName()) ?>"><?= $block->escapeHtml($block->getProduct()->getName()) ?></span>
                    </label>
                    <?= $block->getCurrentProductPriceHtml(); ?>
                </div>
                <?php endif; ?>
            </li>
            <?php foreach ($_items as $_item): ?>
                <?php $isSalable = $_item->isSaleable(); ?>
                <li class="plus"></li>
                <li id="soldtogether-image-<?= (int)$_item->getId() ?>" class="item product-item<?php if (!$isSalable) : ?> item-inactive<?php endif;?>">
                    <?= /* @escapeNotVerified */ '<!-- ' . $imageId . '-->' ?>
                    <span class="product-photo-wrapper">
                        <?php if ($isAmazonStripe): ?>
                            <input type="checkbox"
                               class="checkbox relatedorderamazon-checkbox"
                               <?php if (!$isSalable) : ?>onclick="return false;" disabled="disabled"<?php endif; ?>
                               id="relatedorderstripe-checkbox<?= (int)$_item->getId() ?>"
                               name="bought_related_products[]"
                               value="<?= (int)$_item->getId() ?>"<?php if ($isSalable) : ?> checked="checked"<?php endif; ?> />
                        <?php endif; ?>
                        <a href="<?= $block->escapeUrl($block->getProductUrl($_item)) ?>" class="product photo product-item-photo">
                            <?= $block->getImageHtml($_item, $imageId); ?>
                        </a>
                    </span>
                    <?php if ($isAmazonStripe): ?>
                    <div class="product details product-item-details">
                        <label class="product name product-item-name" for="relatedorderstripe-checkbox<?= (int)$_item->getId() ?>">
                            <a class="product-item-link" title="<?= $block->escapeHtml($_item->getName()) ?>" href="<?= $block->escapeUrl($block->getProductUrl($_item)) ?>"><?= $block->escapeHtml($_item->getName()) ?></a>
                        </label>
                        <?= /* @noEscape */ $block->getProductPrice($_item); ?>
                        <?php if ($detailsHtml = $block->renderDetailsHtml($_item)): ?>
                        <input type="checkbox" class="details-toggler" id="details-toggler-<?= (int)$_item->getId() ?>" /><label for="details-toggler-<?= (int)$_item->getId() ?>" data-show="<?= __('Show details') ?>" data-hide="<?= __('Hide details') ?>"></label>
                        <?= $detailsHtml ?>
                        <?php endif; ?>
                    </div>
                    <?php endif; ?>
                </li>
            <?php endforeach; ?>
        </ul>
        <div class="amazonstyle-checkboxes">
            <?php if ($isAmazonDefault): ?>
            <ul class="product-items-list">
                <li class="product-item-details">
                    <input type="checkbox"
                           class="checkbox main-product"
                           id="relatedorderamazon-checkbox<?= (int)$block->getProduct()->getId() ?>"
                           onclick="return false;"
                           disabled="disabled"
                           name="bought_related_products[]"
                           value="<?= (int)$block->getProduct()->getId() ?>" checked="checked"/>
                    <?= /* @escapeNotVerified */ __('This Item') ?>:
                    <label class="product name product-item-name" for="relatedorderamazon-checkbox<?= (int)$block->getProduct()->getId() ?>">
                        <?= $block->escapeHtml($block->getProduct()->getName()) ?>
                    </label>
                    <?= $block->getCurrentProductPriceHtml(); ?>
                </li>
                <?php foreach ($_items as $_product): ?>
                    <?php $isSalable = $_product->isSalable(); ?>
                    <li class="product-item-details">
                        <input type="checkbox"
                               class="checkbox relatedorderamazon-checkbox"
                               <?php if (!$isSalable) : ?>onclick="return false;" disabled="disabled"<?php endif; ?>
                               id="relatedorderamazon-checkbox<?= (int)$_product->getId() ?>"
                               name="bought_related_products[]"
                               value="<?= (int) $_product->getId() ?>" <?php if ($isSalable) : ?>checked="checked"<?php endif; ?>/>
                        <label class="product name product-item-name" for="relatedorderamazon-checkbox<?= (int)$_product->getId() ?>">
                            <a class="product-item-link" title="<?= $block->escapeHtml($_product->getName()) ?>" href="<?= $block->escapeUrl($block->getProductUrl($_product)) ?>">
                            <?= $block->escapeHtml($_product->getName()) ?></a>
                        </label>
                        <?= /* @noEscape */ $block->getProductPrice($_product); ?>
                        <?php if ($detailsHtml = $block->renderDetailsHtml($_product)): ?>
                        <input type="checkbox" class="details-toggler" id="details-toggler-<?= (int)$_product->getId() ?>" /><label for="details-toggler-<?= (int)$_product->getId() ?>" data-show="<?= __('Show details') ?>" data-hide="<?= __('Hide details') ?>"></label>
                        <?= $detailsHtml ?>
                        <?php endif; ?>
                    </li>
                <?php endforeach; ?>
            </ul>
            <?php endif; ?>

            <div class="button-cart">
                <button type="button" title="Add to Cart" class="action soldtogether-cart-btn primary">
                    <span><span><?= __('Add All to Cart') ?></span></span>
                </button>
            </div>

            <div class="totalprice regular-price">
                <?php if (1 == $taxDisplay || 2 == $taxDisplay) : ?>
                    <div data-role="priceBox" class="price-box price-final_price">
                        <span class="price-label"><?= __('Total price'); ?></span>
                        <span class="price-container price-final_price tax weee">
                            <span class="price-wrapper " data-price-type="finalPrice" >
                                <span class="price"></span>
                            </span>
                        </span>
                    </div>
                <?php else : ?>
                    <div data-role="priceBox" class="price-box price-final_price">
                        <span class="price-container price-final_price tax weee">
                            <span class="price-wrapper price-including-tax"
                                  data-price-type="finalPrice"
                                  data-label="<?= /* @escapeNotVerified */ __('Incl. Tax') ?>"
                                  id="price-including-tax-product-price-all">
                                  <span class="price"></span>
                            </span>
                            <span
                                class="price-wrapper price-excluding-tax"
                                data-price-type="basePrice"
                                data-label="<?= /* @escapeNotVerified */ __('Excl. Tax') ?>"
                                id="price-excluding-tax-product-price-all">
                                <span class="price"></span>
                            </span>
                        </span>
                    </div>
                <?php endif ?>
            </div>
        </div>
    </div>
</div>
<script type="text/x-magento-init">
    {
        "#<?= str_replace('.', '\\\\.', $htmlBlockId) ?>": {
            "Swissup_SoldTogether/js/frequently-bought-together": <?= json_encode([
                'taxDisplay' => $taxDisplay,
                'priceFormat' => $block->getPriceFormat(),
                'mainProductPriceBox' => $block->getMainProductPriceBox() ?: '.product-info-price [data-role=priceBox], .bundle-info [data-role=priceBox]'
            ])?>
        }
    }
</script>
<?php endif; ?>
